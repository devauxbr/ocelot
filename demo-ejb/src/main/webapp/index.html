<!DOCTYPE html>
<html>
	<head>
		<title>Page de test</title>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<script src="ocelot-services.js" type="text/javascript"></script>
		<script src="ocelot-core.js" type="text/javascript"></script>
	</head>
	<body>
		<script>
			var mdb1 = new Mdb("ocelot-status");
			mdb1.onMessage = function (msg) {
				var status = document.getElementById("status");
				if (msg === "OPEN") {
					status.style.backgroundColor = '#0f0';
				} else {
					status.style.backgroundColor = '#f00';
				}
			};
			mdb1.subscribe();
			var mdb = new Mdb("mytopic");
			mdb.onMessage = function (msg) {
				addMessage(msg);
			};
			var pojoService = new TestPojoService();
			var ejbService = new TestEJBService();
			function getErrorMessage(srv) {
				var token = srv.getMessage(true);
				token.success = function (msg) {
					addMessage(msg);
				};
				token.fail = function (fault) {
					alert(fault.message + "\n" + fault.classname + "\n" + fault.stacktrace.join('\n'));
				};
			}
			function getMessage(srv) {
				var token = srv.getMessage(Math.floor(Math.random() * 10));
				token.success = function (msg) {
					addMessage(msg);
				};
				token.fail = function (fault) {
					alert(fault.message + "\n" + fault.classname + "\n" + fault.stacktrace.join('\n'));
				};
			}
			function getMessageCached(srv) {
				var token = srv.getMessageCached();
				token.success = function (msg) {
					addMessage(msg);
				};
				token.fail = function (fault) {
					alert(fault.message + "\n" + fault.classname + "\n" + fault.stacktrace.join('\n'));
				};
			}
			function getMessageCached2(srv) {
				var token = srv.getMessageCached2(1, {"id":"5"}, Math.random(), 5, true);
				token.success = function (msg) {
					addMessage(msg);
				};
				token.fail = function (fault) {
					alert(fault.message + "\n" + fault.classname + "\n" + fault.stacktrace.join('\n'));
				};
			}
			function getMessageAndCleanCache(srv) {
				var token = srv.getMessageCachedAndCleanCache({"id":"5"}, 1, Math.random(), 5, true);
				token.success = function (msg) {
					addMessage(msg);
				};
				token.fail = function (fault) {
					alert(fault.message + "\n" + fault.classname + "\n" + fault.stacktrace.join('\n'));
				};
			}
			function getMessage2(srv) {
				var token = srv.getMessage("" + Math.floor(Math.random() * 10));
				token.success = function (msg) {
					addMessage(msg);
				};
				token.fail = function (fault) {
					alert(fault.message + "\n" + fault.classname + "\n" + fault.stacktrace.join('\n'));
				};
			}
			function addMessage(msg) {
				var output = document.getElementById("output");
				var pre = document.createElement("p");
				pre.style.wordWrap = "break-word";
				pre.innerHTML = msg;
				output.appendChild(pre);
			}

			function showObject() {
				var obj = eval(document.getElementById("testobject").value);
				document.getElementById("objectarea").textContent = JSON.stringify(obj).replace(/,/g, ",\n");
			}
			var ocelotServices = new OcelotServices();
			var tokenLocale = ocelotServices.getLocale();
			tokenLocale.success = function(locale) {
				var localeSelector = document.getElementById("localeSelector");
				for (i = 0; i < localeSelector.options.length; i++) {
					var currentLocale = JSON.parse(localeSelector.options[i].value);
					if(currentLocale.language === locale.language && currentLocale.country === locale.country) {
						localeSelector.options.selectedIndex = i;
						break;
					}
				}
			}
			function changeLocale() {
				var localeSelector = document.getElementById("localeSelector");
				var idx = localeSelector.options.selectedIndex;
				var currentLocale = JSON.parse(localeSelector.options[idx].value);
				var token = ocelotServices.setLocale(currentLocale);
				token.success = function(msg) {
					location.reload();
				}
			}
		</script>
		<div id="status" style="width:10px;height:10px;background-color:#f00">X</div>
		<input id="testobject" type="text" value="document.location"/>
		<select id="localeSelector" onchange="changeLocale()">
			<option value='{"language":"fr","country":"FR"}' selected>fr</option>
			<option value='{"language":"en","country":"US"}'>en</option>
		</select>
		<button onclick="showObject()">SHOW OBJECT</button><br>
		<textarea style="height:200px;width:100%" id="objectarea"></textarea><br>
		<button onclick="ocelotController.close()">CLOSE WS</button><button onclick="mdb.subscribe();">SUBSCRIBE</button><button onclick="mdb.unsubscribe();">UNSUBSCRIBE</button><br>
		<button onclick="getMessage(ejbService)">GET EJB MESSAGE(int)</button><button onclick="getMessage2(ejbService)">GET EJB MESSAGE(str)</button><br>
		<button onclick="getMessageCached(ejbService)">GET EJB MESSAGE CACHED 1Mn</button><br>
		<button onclick="getMessageCached2(ejbService)">GET EJB MESSAGE2 CACHED 1Mn</button><br>
		<button onclick="getMessageAndCleanCache(ejbService)">GET EJB MESSAGE AND CLEAN CACHE2 1Mn</button><br>
		<button onclick="getMessage(pojoService)">GET POJO MESSAGE(int)</button><br>
		<button onclick="getMessage2(pojoService)">GET POJO MESSAGE(str)</button><br>
		<button onclick="getErrorMessage(pojoService)">GET ERROR MESSAGE</button><br>
		<div id="output"></div>
	</body>
</html>
